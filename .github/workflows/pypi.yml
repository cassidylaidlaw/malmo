name: Publish to PyPI

on:
  workflow_dispatch:
  push:
    tags:
      - v*
    branches:
      - dylan/publish-to-pypi

jobs:
  publish:
    runs-on: ubuntu
    steps:
      - name: Download wheels
        id: download-artifact
        uses: dawidd6/action-download-artifact@v2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: master
          workflow: wheels.yml
          workflow_conclusion: ''

      - name: Copy wheels to dist
        run: |
          mkdir -p dist;
          find . -type d -name 'wheels-*' -exec sh -c 'cp -v "$1"/* dist/' _ {} \;
          
      - name: Display output
        run: |
          ls -l dist

      - name: Install Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.9

      - name: Publish distribution to PyPI
        if: startsWith(github.ref, 'refs/tags')
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.TEST_PYPI_API_TOKEN }}
          repository-url: https://test.pypi.org/legacy/

        
  # publish:
  #   name: Publish to PyPI
  #   runs-on: ubuntu-latest

  #   steps:
  #     - uses: actions/checkout@v2

  #     - name: Install Python
  #       uses: actions/setup-python@v2
  #       with:
  #         python-version: 3.8

  #     - name: Cache pip
  #       uses: actions/cache@v1
  #       with:
  #         path: ~/.cache/pip  # This path is specific to Ubuntu
  #         key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
  #         restore-keys: |
  #           ${{ runner.os }}-pip-

  #     - name: Install pypa/build
  #       run: |
  #         python -m pip install build --user
  #     - name: Build a binary wheel and a source tarball
  #       run: |
  #         python -m build --sdist --wheel --outdir dist/ .
  #     - name: Publish distribution to PyPI
  #       if: startsWith(github.ref, 'refs/tags')
  #       uses: pypa/gh-action-pypi-publish@release/v1
  #       with:
            
  #         password: ${{ secrets.PYPI_API_TOKEN }}